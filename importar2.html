<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Hosts Simplificado</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: linear-gradient(120deg,#0f172a,#1e293b); color:white; font-family:Arial,sans-serif; padding:40px;}
.container { max-width:1000px; margin:auto; }
.card { background:#1e293b; padding:20px; border-radius:12px; margin-bottom:20px;}
button { font-weight:bold; cursor:pointer; border:none; border-radius:6px; padding:10px 20px; margin-top:10px;}
.btn-brand { background: linear-gradient(90deg,#2563eb,#3b82f6); color:#fff; }
.btn-brand:hover { filter:brightness(1.05);}
.status { margin-top:10px; font-weight:bold; }
table { width:100%; margin-top:20px; border-collapse:collapse;}
th,td { border:1px solid #334155; padding:8px; text-align:left;}
th { background:#1e293b; }
tr:nth-child(even){ background:#1f2937; }
</style>
</head>
<body>

<div class="container">
  <h2>Painel de Hosts Simplificado</h2>

  <div class="card">
    <h3>Buscar Host</h3>
    <div class="mb-3">
      <input type="text" id="hostSearch" class="form-control" placeholder="Digite apelido ou Kwai ID">
      <select id="hostSelect" class="form-select mt-2" size="5"></select>
    </div>

    <div class="mb-3">
      <label>Mês</label>
      <select id="mesInput" class="form-select">
        ${Array.from({length:12}, (_,i)=>`<option value="${i+1}">${["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][i]}</option>`).join('')}
      </select>
    </div>
    <div class="mb-3">
      <label>Ano</label>
      <input type="number" id="anoInput" class="form-control" value="2026">
    </div>

    <button class="btn btn-brand" id="btnFiltrar">Filtrar</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h3>Dados do Host</h3>
    <table id="tabelaDados">
      <thead>
        <tr>
          <th>UID</th>
          <th>Apelido</th>
          <th>Kwai ID</th>
          <th>Nome Agente</th>
          <th>Duração Transmissão</th>
          <th>Dias Efetivos</th>
          <th>Fluxo Presentes</th>
          <th>Duração Vídeo</th>
          <th>Duração Áudio</th>
          <th>Receita Vídeo</th>
          <th>Receita Áudio</th>
          <th>Dias Vídeo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";

await protectPage();

const hostSearch = document.getElementById('hostSearch');
const hostSelect = document.getElementById('hostSelect');
const tabelaDados = document.querySelector('#tabelaDados tbody');
const status = document.getElementById('status');
const mesInput = document.getElementById('mesInput');
const anoInput = document.getElementById('anoInput');

let hostsData = [];

// Carregar hosts
async function carregarHosts() {
  const { data, error } = await supabase
    .from('hosts_simplificado')
    .select('member_id,apelido,kwai_id,nome_agente')
    .order('apelido');

  if(error){ status.innerText = "Erro ao carregar hosts: "+error.message; return; }
  hostsData = data;
  atualizarSelect('');
}

// Atualizar select com filtro
function atualizarSelect(filtro){
  hostSelect.innerHTML = '';
  const filtrados = hostsData.filter(h =>
    (h.apelido?.toLowerCase().includes(filtro.toLowerCase())) ||
    (h.kwai_id?.toLowerCase().includes(filtro.toLowerCase()))
  );

  if(filtrados.length===0) hostSelect.innerHTML = '<option value="">Nenhum host encontrado</option>';
  else filtrados.forEach(h=>{
    hostSelect.innerHTML += `<option value="${h.member_id}">${h.apelido} / ${h.kwai_id}</option>`;
  });
}

hostSearch.addEventListener('input', e=>atualizarSelect(e.target.value));

document.getElementById('btnFiltrar').addEventListener('click', async ()=>{
  tabelaDados.innerHTML = '';
  status.innerText = '';

  const memberId = hostSelect.value;
  const mes = Number(mesInput.value);
  const ano = Number(anoInput.value);

  if(!memberId){ status.innerText='Selecione um host'; return; }

  status.innerText='Carregando...';

  const { data, error } = await supabase
    .from('host_reports_simplificada') // a view simplificada que você vai criar
    .select('*')
    .eq('member_id', memberId)
    .eq('mes', mes)
    .eq('ano', ano);

  if(error){ status.innerText='Erro: '+error.message; return; }
  if(!data || data.length===0){ status.innerText='Nenhum dado encontrado'; return; }

  data.forEach(d=>{
    tabelaDados.innerHTML+=`
      <tr>
        <td>${d.member_id||''}</td>
        <td>${d.apelido||''}</td>
        <td>${d.kwai_id||''}</td>
        <td>${d.nome_agente||''}</td>
        <td>${d.duracao_transmissao||''}</td>
        <td>${d.dias_efetivos||''}</td>
        <td>${d.fluxo_presentes||''}</td>
        <td>${d.duracao_video||''}</td>
        <td>${d.duracao_audio||''}</td>
        <td>${d.receita_video||''}</td>
        <td>${d.receita_audio||''}</td>
        <td>${d.dias_video||''}</td>
      </tr>
    `;
  });

  status.innerText=`Mostrando ${data.length} registro(s)`;
});

carregarHosts();
</script>

</body>
</html>
