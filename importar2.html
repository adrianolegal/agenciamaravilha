<div class="card">
  <h3>Filtrar dados do Host</h3>

  <div class="mb-3">
    <label>Host</label>
    <select id="hostSelect" class="form-select">
      <option value="">--Selecione um host--</option>
    </select>
  </div>

  <div class="mb-3">
    <label>Mês</label>
    <select id="mesInput" class="form-select">
      <option value="1">Janeiro</option>
      <option value="2">Fevereiro</option>
      <option value="3">Março</option>
      <option value="4">Abril</option>
      <option value="5">Maio</option>
      <option value="6">Junho</option>
      <option value="7">Julho</option>
      <option value="8">Agosto</option>
      <option value="9">Setembro</option>
      <option value="10">Outubro</option>
      <option value="11">Novembro</option>
      <option value="12">Dezembro</option>
    </select>
  </div>

  <div class="mb-3">
    <label>Ano</label>
    <input type="number" id="anoInput" class="form-control" value="2026">
  </div>

  <button class="btn btn-brand" id="btnFiltrar">Filtrar</button>
  <div id="status" class="status"></div>

  <table class="table table-striped mt-3" id="resultsTable">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Apelido</th>
        <th>Member ID</th>
        <th>Duração Vídeo</th>
        <th>Duração Áudio</th>
        <th>Receita Vídeo</th>
        <th>Receita Áudio</th>
        <th>Dias Vídeo</th>
        <th>Mês</th>
        <th>Ano</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { supabase } from "./supabase.js";

const hostSelect = document.getElementById("hostSelect");
const mesInput = document.getElementById("mesInput");
const anoInput = document.getElementById("anoInput");
const btnFiltrar = document.getElementById("btnFiltrar");
const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
const status = document.getElementById("status");

// Carrega hosts do Supabase
async function carregarHosts() {
  const { data: hosts, error } = await supabase
    .from('hosts')
    .select('member_Id,nome_agente,apelido_streamer');

  if (error) {
    status.innerText = "Erro ao carregar hosts: " + error.message;
    return;
  }

  hostSelect.innerHTML = '<option value="">--Selecione um host--</option>' +
    hosts.map(h => `<option value="${h.member_Id}">${h.nome_agente} (${h.apelido_streamer})</option>`).join('');
}

// Filtra os dados do host selecionado
async function filtrar() {
  const member_id = hostSelect.value;
  const mes = Number(mesInput.value);
  const ano = Number(anoInput.value);

  resultsTable.innerHTML = '';
  status.innerText = '';

  if (!member_id) return status.innerText = "Selecione um host";
  if (!mes || !ano) return status.innerText = "Selecione mês e ano válidos";

  status.innerText = "Carregando...";

  const { data, error } = await supabase
    .from('host_reports')
    .select('*')
    .eq('member_id', Number(member_id))
    .eq('mes', mes)
    .eq('ano', ano);

  if (error) {
    status.innerText = "Erro: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    status.innerText = "Nenhum dado encontrado";
    return;
  }

  data.forEach(row => {
    resultsTable.innerHTML += `
      <tr>
        <td>${row.nome_agente || ''}</td>
        <td>${row.apelido_streamer || ''}</td>
        <td>${row.member_id || ''}</td>
        <td>${row.duracao_video || ''}</td>
        <td>${row.duracao_audio || ''}</td>
        <td>${row.receita_video || ''}</td>
        <td>${row.receita_audio || ''}</td>
        <td>${row.dias_video || ''}</td>
        <td>${row.mes || ''}</td>
        <td>${row.ano || ''}</td>
      </tr>
    `;
  });

  status.innerText = `Mostrando ${data.length} registro(s)`;
}

// Eventos
btnFiltrar.addEventListener('click', filtrar);

// Carrega hosts ao abrir a página
carregarHosts();
</script>
