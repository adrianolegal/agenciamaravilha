<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Hosts - Agência Maravilha</title>
<link rel="icon" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color: white;
  font-family: Arial, sans-serif;
  padding: 40px;
}
.container { max-width: 1000px; margin:auto; }
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
button {
  font-weight:bold;
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:10px 20px;
  margin-top:10px;
}
.btn-brand{
  background: linear-gradient(90deg, #2563eb, #3b82f6);
  border:none;
  color:#ffffff;
}
.btn-brand:hover{ filter:brightness(1.05); }
.btn-success { background:#16a34a; color:white; }
.btn-error { background:#dc2626; color:white; }
.status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
.fade { animation: fade 0.5s ease-in-out; }
.table { color: white; }
@keyframes fade { from { opacity:0 } to { opacity:1 } }
</style>
</head>

<body>

<div class="container">
  <h2>Painel de Hosts v01</h2>

  <div class="card">
    <h3>Filtrar dados do Host</h3>

    <div class="mb-3">
      <label>Host</label>
      <select id="hostSelect" class="form-select">
        <option value="">--Selecione um host--</option>
      </select>
    </div>

    <div class="mb-3">
      <label>Mês</label>
      <select id="mesInput" class="form-select">
        <option value="1">Janeiro</option>
        <option value="2">Fevereiro</option>
        <option value="3">Março</option>
        <option value="4">Abril</option>
        <option value="5">Maio</option>
        <option value="6">Junho</option>
        <option value="7">Julho</option>
        <option value="8">Agosto</option>
        <option value="9">Setembro</option>
        <option value="10">Outubro</option>
        <option value="11">Novembro</option>
        <option value="12">Dezembro</option>
      </select>
    </div>

    <div class="mb-3">
      <label>Ano</label>
      <input type="number" id="anoInput" class="form-control" value="2026">
    </div>

    <button class="btn btn-brand" id="btnFiltrar">Filtrar</button>
    <div id="status" class="status"></div>

    <table class="table table-striped mt-3" id="resultsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Apelido</th>
          <th>Member ID</th>
          <th>Duração Vídeo</th>
          <th>Duração Áudio</th>
          <th>Receita Vídeo</th>
          <th>Receita Áudio</th>
          <th>Dias Vídeo</th>
          <th>Mês</th>
          <th>Ano</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn btn-error" id="btnLogout">Logout</button>
</div>

<script type="module">
import { supabase, logout } from "./supabase.js";

const hostSelect = document.getElementById("hostSelect");
const mesInput = document.getElementById("mesInput");
const anoInput = document.getElementById("anoInput");
const btnFiltrar = document.getElementById("btnFiltrar");
const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
const status = document.getElementById("status");

// Carrega hosts da tabela hosts
async function carregarHosts() {
  const { data: hosts, error } = await supabase
    .from('hosts')
    .select('member_Id,nome_agente,apelido_streamer');

  if (error) {
    status.innerText = "Erro ao carregar hosts: " + error.message;
    return;
  }

  hostSelect.innerHTML = '<option value="">--Selecione um host--</option>' +
    hosts.map(h => `<option value="${h.member_Id}">${h.nome_agente} (${h.apelido_streamer})</option>`).join('');
}

// Filtra os dados do host selecionado
async function filtrar() {
  const member_id = hostSelect.value;
  const mes = Number(mesInput.value);
  const ano = Number(anoInput.value);

  resultsTable.innerHTML = '';
  status.innerText = '';

  if (!member_id) return status.innerText = "Selecione um host";
  if (!mes || !ano) return status.innerText = "Selecione mês e ano válidos";

  status.innerText = "Carregando...";

  const { data, error } = await supabase
    .from('host_reports')
    .select('*')
    .eq('member_id', Number(member_id))
    .eq('mes', mes)
    .eq('ano', ano);

  if (error) {
    status.innerText = "Erro: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    status.innerText = "Nenhum dado encontrado";
    return;
  }

  data.forEach(row => {
    resultsTable.innerHTML += `
      <tr>
        <td>${row.nome_agente || ''}</td>
        <td>${row.apelido_streamer || ''}</td>
        <td>${row.member_id || ''}</td>
        <td>${row.duracao_video || ''}</td>
        <td>${row.duracao_audio || ''}</td>
        <td>${row.receita_video || ''}</td>
        <td>${row.receita_audio || ''}</td>
        <td>${row.dias_video || ''}</td>
        <td>${row.mes || ''}</td>
        <td>${row.ano || ''}</td>
      </tr>
    `;
  });

  status.innerText = `Mostrando ${data.length} registro(s)`;
}

// Eventos
btnFiltrar.addEventListener('click', filtrar);
document.getElementById("btnLogout").addEventListener("click", logout);

// Carrega hosts ao abrir a página
carregarHosts();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta Hosts - Agência Maravilha</title>
<link rel="icon" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">
<style>
body {
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color: white;
  font-family: Arial, sans-serif;
  padding: 40px;
}
.container { max-width: 900px; margin:auto; }
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
button {
  font-weight:bold;
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:10px 20px;
  margin-top:10px;
}
.btn-brand{
  background: linear-gradient(90deg, #2563eb, #3b82f6);
  border:none;
  color:#ffffff;
}
.btn-brand:hover{ filter:brightness(1.05); }
.btn-success { background:#16a34a; color:white; }
.btn-error { background:#dc2626; color:white; }
.status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
table { width:100%; margin-top:20px; border-collapse: collapse; }
th, td { border:1px solid #334155; padding:8px; text-align:left; }
th { background:#1e293b; }
tr:nth-child(even){ background:#1f2937; }
</style>
</head>
<body>

<div class="container">
  <h2>Consulta de Hosts</h2>

  <div class="card">
    <h3>Filtrar Host</h3>
    <div class="mb-3">
      <label>Host (apelido ou Kwai ID)</label>
      <input type="text" id="hostSearch" class="form-control" placeholder="Digite apelido ou Kwai ID">
      <select id="hostSelect" class="form-select mt-2" size="5"></select>
    </div>

    <div class="mb-3">
      <label>Mês</label>
      <select id="mesInput" class="form-select">
        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
      </select>
    </div>
    <div class="mb-3">
      <label>Ano</label>
      <input type="number" id="anoInput" class="form-control" value="2026">
    </div>

    <button class="btn btn-brand" id="btnFiltrar">Filtrar</button>
    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h3>Dados do Host</h3>
    <table id="tabelaDados">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Apelido</th>
          <th>Kwai ID</th>
          <th>Duração Vídeo</th>
          <th>Duração Áudio</th>
          <th>Receita Vídeo</th>
          <th>Receita Áudio</th>
          <th>Mes</th>
          <th>Ano</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";

await protectPage(); // protege a página

const hostSelect = document.getElementById('hostSelect');
const hostSearch = document.getElementById('hostSearch');
const status = document.getElementById('status');
const tabelaDados = document.querySelector('#tabelaDados tbody');

let hostsData = [];

// Carregar hosts ativos
async function carregarHosts() {
  const { data, error } = await supabase
    .from('hosts')
    .select('member_id,nome_agente,apelido_streamer,kwai_id,ativo')
    .eq('ativo', true)
    .order('nome_agente');

  if (error) { status.innerText = "Erro ao carregar hosts: " + error.message; return; }

  hostsData = data;
  atualizarSelect('');
}

// Atualiza select com filtro
function atualizarSelect(filtro) {
  hostSelect.innerHTML = '';
  const filtrados = hostsData.filter(h =>
    h.apelido_streamer.toLowerCase().includes(filtro.toLowerCase()) ||
    h.kwai_id.toLowerCase().includes(filtro.toLowerCase())
  );

  if(filtrados.length===0) hostSelect.innerHTML = '<option value="">Nenhum host encontrado</option>';
  else filtrados.forEach(h => {
    const text = `${h.nome_agente} (${h.apelido_streamer} / ${h.kwai_id})`;
    hostSelect.innerHTML += `<option value="${h.member_id}">${text}</option>`;
  });
}

// Evento de pesquisa
hostSearch.addEventListener('input', e => atualizarSelect(e.target.value));

// Botão filtrar
document.getElementById('btnFiltrar').addEventListener('click', async () => {
  tabelaDados.innerHTML = '';
  status.innerText = '';

  const memberId = hostSelect.value;
  const mes = Number(document.getElementById('mesInput').value);
  const ano = Number(document.getElementById('anoInput').value);

  if(!memberId){ status.innerText = 'Selecione um host'; return; }

  // Puxar dados da tabela host_reports
  const { data, error } = await supabase
    .from('host_reports')
    .select('*')
    .eq('member_id', memberId)
    .eq('mes', mes)
    .eq('ano', ano);

  if(error){ status.innerText = "Erro: " + error.message; return; }
  if(data.length===0){ status.innerText = "Nenhum dado encontrado"; return; }

  data.forEach(d => {
    tabelaDados.innerHTML += `
      <tr>
        <td>${d.nome_agencia || ''}</td>
        <td>${d.apelido_streamer || ''}</td>
        <td>${d.kwai_id || ''}</td>
        <td>${d.duracao_video || ''}</td>
        <td>${d.duracao_audio || ''}</td>
        <td>${d.receita_video || ''}</td>
        <td>${d.receita_audio || ''}</td>
        <td>${d.mes}</td>
        <td>${d.ano}</td>
      </tr>
    `;
  });
});

// Inicializa
carregarHosts();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
