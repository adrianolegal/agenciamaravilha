<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Importar Relatório Host</title>

<style>
body {
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
    padding: 40px;
}

.container {
    max-width: 600px;
    margin: auto;
}

input, button {
    padding: 10px;
    margin-top: 10px;
    width: 100%;
    border-radius: 6px;
    border: none;
}

button {
    background: #ff6600;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
}

button:hover {
    opacity: 0.9;
}

.status {
    margin-top: 15px;
    font-weight: bold;
}
</style>
</head>
<body>

<div class="container">
    <h2>Importar Relatório Host</h2>
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <button id="btnImport">Importar</button>
    <div class="status" id="status"></div>
</div>

<script type="module">

import { supabase } from "./supabase.js";
import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

const statusDiv = document.getElementById("status");

document.getElementById("btnImport").addEventListener("click", async () => {

    const file = document.getElementById("fileInput").files[0];

    if (!file) {
        statusDiv.innerText = "Selecione um arquivo.";
        return;
    }

    statusDiv.innerText = "Lendo arquivo...";

    const reader = new FileReader();

    reader.onload = async (e) => {

        try {

            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let json = XLSX.utils.sheet_to_json(sheet);

            const formatted = json.map(row => ({
                member_id: Number(row.member_Id) || null,
                kwai_id: row.kwaiId || null,
                agencia_id: row["ID da agência"] || null,
                nome_agencia: row["Nome da Agência"] || null,
                apelido_streamer: row["Apelido de streamer"] || null,
                nome_agente: row["Nome do agente"] || null,
                duracao_transmissao: row["Duração da transmissão ao vivo"] || null,
                dias_transmissao: row["Dia(s) da transmissão ao vivo"] || null,
                dias_efetivos: row["Dia(s) efetivo(s) da transmissão  ao vivo"] || null,
                fluxo_presentes: row["Fluxo de presentes"] || null,
                novos_fas: row["Novos fãs da sala de transmissão ao vivo"] || null,
                duracao_video: row["Duração de live de vídeo"] || null,
                duracao_audio: row["Duração de live de áudio"] || null,
                receita_video: row["Receita de live de vídeo"] || null,
                receita_audio: row["Receita de presentes de live de áudio"] || null,
                dias_video: row["Dias efetivos de live de vídeo"] || null,
                presentes_convidado_video: row["Presentes recebidos como convidado de live em grupo de vídeo"] || null,
                presentes_streamer_video: row["Presentes recebidos como streamer de live em grupo de vídeo"] || null,
                presentes_convidado_audio: row["Presentes recebidos como convidado de live em grupo de áudio"] || null,
                presentes_streamer_audio: row["Presentes recebidos como streamer de live em grupo de áudio"] || null,
                duracao_chat: row["A duração da transmissão ao vivo da sala de bate-papo"] || null,
                sala_chat: row["Sala de chat com transmissão ao vivo"] || null,
                fluxo_caixa_magica: row["Fluxo de Caixa Mágica"] || null,
                data_entrada: row["Data de entrada"] || null,
                ultima_live: row["Última transmissão ao vivo em"] || null,
                ultima_publicacao: row["Última publicação em"] || null
            }));

            const { error } = await supabase
                .from("host_reports")
                .insert(formatted);

            if (error) {
                console.error(error);
                statusDiv.innerText = "Erro: " + error.message;
                return;
            }

            statusDiv.innerText = "Importação concluída.";

        } catch (err) {
            console.error(err);
            statusDiv.innerText = "Erro inesperado.";
        }

    };

    reader.readAsArrayBuffer(file);
});

</script>
