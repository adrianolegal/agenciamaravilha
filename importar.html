<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importar - Agência Maravilha</title>
<link rel="icon" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">
</head>

<body>
<div class="container">
  <h2>Importação de Dados V.02.0</h2>

  <div class="card">
    <h3>Importar Hosts (Tabela 1)</h3>
    <input type="file" id="fileHosts" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportHosts">Importar Hosts</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <div class="card">
    <h3>Importar Relatórios (Tabela 2)</h3>
    <input type="file" id="fileReports" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportReports">Importar Reports</button>
    <div id="statusReports" class="status"></div>
  </div>

  <button class="btn btn-error" id="btnLogout">Logout</button>
</div>

<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";

await protectPage();

function showStatus(element, text, type="") {
  element.className = "status " + type;
  element.innerText = text;
  setTimeout(() => { element.innerText = ""; }, 5000); // some depois de 5s
}

// Normaliza dados para host_reports (datas e números grandes)
function normalizeReportsData(data) {
  return data.map(row => {
    const normalized = { ...row };
    for (const key in normalized) {
      if (typeof normalized[key] === "string" && /^\d{4}-\d{2}-\d{2}/.test(normalized[key])) {
        // tenta transformar datas
        const d = new Date(normalized[key]);
        if (!isNaN(d)) normalized[key] = d.toISOString();
      }
      // corrige números grandes (member_id etc)
      if (!isNaN(normalized[key]) && Number(normalized[key]) > 1e10) {
        normalized[key] = Number(normalized[key].toString().replace(/[^\d]/g,''));
      }
    }
    return normalized;
  });
}

// IMPORT HOSTS
document.getElementById("btnImportHosts").addEventListener("click", async () => {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);
    const { error } = await supabase.from('hosts').upsert(data, { onConflict: 'member_Id' });
    if (error) showStatus(status, "Erro ao importar: " + error.message, "btn-error");
    else showStatus(status, "Importado com sucesso ✓", "btn-success");
  };
  reader.readAsBinaryString(file);
});

// IMPORT HOST_REPORTS
document.getElementById("btnImportReports").addEventListener("click", async () => {
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    let data = XLSX.utils.sheet_to_json(sheet);
    data = normalizeReportsData(data);

    const { error } = await supabase.from('host_reports').insert(data);
    if (error) showStatus(status, "Erro ao importar: " + error.message, "btn-error");
    else showStatus(status, "Importado com sucesso ✓", "btn-success");
  };
  reader.readAsBinaryString(file);
});

// LOGOUT
document.getElementById("btnLogout").addEventListener("click", logout);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
