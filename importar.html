<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importar - Agência Maravilha</title>
<link rel="icon" type="image/png" href="assets/favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#0f172a; color:white; font-family:Arial,sans-serif; padding:40px;}
.container {max-width:600px; margin:auto;}
.card {background:#1e293b; padding:20px; border-radius:12px; margin-bottom:20px;}
button {padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;}
.success { background:#16a34a }
.error { background:#dc2626 }
.info { background:#2563eb }
.status {margin-top:10px; font-weight:bold; transition: all 0.3s ease;}
.fade {animation: fade 0.5s ease-in-out;}
@keyframes fade {from { opacity:0 } to { opacity:1 }}
</style>
</head>
<body>

<div class="container">
<h2>Painel Admin</h2>

<div class="card">
<h3>Importar Hosts (Tabela 1)</h3>
<input type="file" id="fileHosts" accept=".xlsx">
<button class="info" id="btnImportHosts">Importar</button>
<div id="statusHosts" class="status"></div>
</div>

<div class="card">
<h3>Importar Relatório Lives (Tabela 2)</h3>
<input type="file" id="fileReports" accept=".xlsx">
<button class="info" id="btnImportReports">Importar</button>
<div id="statusReports" class="status"></div>
</div>

<button class="error" id="btnLogout">Logout</button>
</div>

<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";

// Protege página
protectPage();

// Função de status
function showStatus(element, text, type) {
  element.className = "status fade " + type;
  element.innerText = text;
}

// IMPORT HOSTS
document.getElementById("btnImportHosts").addEventListener("click", async () => {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");
  if(!file) return showStatus(status, "Selecione um arquivo", "error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    const { error } = await supabase.from('hosts').upsert(data, { onConflict:'member_id' });
    if(error) showStatus(status, "Erro ao importar", "error");
    else showStatus(status, "Importado com sucesso ✓", "success");
  };
  reader.readAsBinaryString(file);
});

// IMPORT REPORTS
document.getElementById("btnImportReports").addEventListener("click", async () => {
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");
  if(!file) return showStatus(status, "Selecione um arquivo", "error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type:'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    const { error } = await supabase.from('host_reports').insert(data);
    if(error) showStatus(status, "Erro ao importar", "error");
    else showStatus(status, "Importado com sucesso ✓", "success");
  };
  reader.readAsBinaryString(file);
});

// LOGOUT
document.getElementById("btnLogout").addEventListener("click", logout);
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
