<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importar Hosts - Agência Maravilha</title>
<link rel="icon" type="image/png" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">
<style>
body { background: #0f172a; color: #fff; font-family: Arial, sans-serif; }
.container-import { max-width: 700px; margin: 50px auto; background: #1e293b; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
h2 { margin-bottom: 20px; text-align: center; }
input[type="file"] { margin-bottom: 15px; }
#btnUpload { background: #2563eb; color: #fff; font-weight: bold; padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; }
#btnUpload:hover { opacity: 0.85; cursor: pointer; }
#msg { margin-top: 15px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<div class="container-import">
  <h2>Importar Hosts Excel</h2>
  <input type="file" id="fileInput" accept=".xlsx">
  <button id="btnUpload">Importar Excel</button>
  <p id="msg"></p>
</div>

<script type="module">
import { supabase } from "./supabase.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mjs";

function formatMemberId(val) {
  // remove notação científica e transforma em inteiro
  return Number(String(val).replace(/\D/g,''));
}

function formatDate(val) {
  // tenta converter datas do Excel para YYYY-MM-DD HH:mm:ss
  if (!val) return null;
  const d = new Date(val);
  if (isNaN(d)) return String(val); // mantém se não for data válida
  return d.toISOString().slice(0,19).replace('T',' ');
}

document.getElementById("btnUpload").addEventListener("click", async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) {
    document.getElementById("msg").textContent = "Selecione um arquivo Excel!";
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: null });

    // normaliza os dados para o Supabase
    const formatted = jsonData.map(row => ({
      member_Id: formatMemberId(row["member_Id"]),
      "Apelido de streamer": row["Apelido de streamer"] || null,
      kwaiId: row["kwaiId"] || null,
      "Status de streamer": row["Status de streamer"] || null,
      "Data de entrada": formatDate(row["Data de entrada"]),
      "Última transmissão ao vivo em": formatDate(row["Última transmissão ao vivo em"]),
      "Última publicação em": formatDate(row["Última publicação em"]),
      "Fluxo da transmissão ao vivo este  mês": Number(row["Fluxo da transmissão ao vivo este  mês"] || 0),
      "Duração da transmissão ao vivo  este mês": row["Duração da transmissão ao vivo  este mês"] || null,
      "Dias válidos de transmissão ao  vivo este mês": Number(row["Dias válidos de transmissão ao  vivo este mês"] || 0)
    }));

    try {
      const { data, error } = await supabase.from("hosts").upsert(formatted, { onConflict: "member_Id" });
      if (error) {
        document.getElementById("msg").textContent = "Erro ao importar: " + error.message;
      } else {
        document.getElementById("msg").textContent = "Importação concluída com sucesso! Total: " + data.length;
      }
    } catch (err) {
      document.getElementById("msg").textContent = "Erro inesperado: " + err.message;
    }

    // limpa mensagem após 5 segundos
    setTimeout(() => { document.getElementById("msg").textContent = ""; }, 5000);
  };
  reader.readAsArrayBuffer(file);
});
</script>

</body>
</html>
