<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importar - AgÃªncia Maravilha</title>
<link rel="icon" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color: white;
  font-family: Arial, sans-serif;
  padding: 40px;
}
.container { max-width: 800px; margin:auto; }
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}

/* BOTÃ•ES */
button {
  font-weight:bold;
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:10px 20px;
  margin-top:10px;
  transition: all 0.3s ease;
  text-shadow: 0 0 2px rgba(0,0,0,0.4);
}

.btn-brand {
  background: linear-gradient(90deg, var(--brand, #2563eb), var(--brand2, #1e40af));
  border: none;
  color: #ffffff !important;
}

.btn-brand:hover {
  filter: brightness(1.05);
  color: #ffffff !important;
  text-decoration: none;
}

.btn-success { 
  background:#16a34a; 
  color:white; 
}

.btn-error { 
  background:#dc2626; 
  color:white; 
}

.btn-outline-light {
  border-color: rgba(255,255,255,.25) !important;
  color: #ffffff !important;
}

input[type="file"] {
  color: #ffffff; /* texto "Nenhum arquivo escolhido" */
}

input[type="file"]::-webkit-file-upload-button {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}

input[type="file"]::file-selector-button {
  background: #2563eb;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}

.status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
.fade { animation: fade 0.5s ease-in-out; }
@keyframes fade { from { opacity:0 } to { opacity:1 } }
</style>
</head>

<body>

<div class="container">
  <h2>ImportaÃ§Ã£o de Dados V.01.4</h2>

  <div class="card">
    <h3>Importar Hosts (Tabela 1)</h3>
    <input type="file" id="fileHosts" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportHosts">Importar Hosts</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <div class="card">
    <h3>Importar RelatÃ³rios Lives (Tabela 2)</h3>
    <input type="file" id="fileReports" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportReports">Importar Reports</button>
    <div id="statusReports" class="status"></div>
  </div>

  <button class="btn btn-error" id="btnLogout">Logout</button>
</div>

<!-- Modal MÃªs/Ano -->
<div class="modal fade" id="modalPeriodo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Selecionar MÃªs e Ano</h5>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>MÃªs</label>
          <select id="mesInput" class="form-select">
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">MarÃ§o</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </div>
        <div>
          <label>Ano</label>
          <input type="number" id="anoInput" class="form-control" value="2025">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="confirmarPeriodo">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";
import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

await protectPage();

function showStatus(element, text, type="") {
  element.className = "status fade " + type;
  element.innerText = text;
}

// ðŸ”¹ Hosts
document.getElementById("btnImportHosts").addEventListener("click", async () => {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const workbook = XLSX.read(e.target.result, { type: 'binary' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      let data = XLSX.utils.sheet_to_json(sheet);
      const normalized = data.map(row => {
        const obj = {};
        Object.keys(row).forEach(key => obj[key.trim()] = row[key]);
        return obj;
      });
      const { error } = await supabase.from('hosts').upsert(normalized, { onConflict: 'member_Id' });
      if (error) showStatus(status, "Erro: " + error.message, "btn-error");
      else showStatus(status, "Importado com sucesso âœ“", "btn-success");
    } catch (err) {
      showStatus(status, "Erro: " + err.message, "btn-error");
    }
  };
  reader.readAsBinaryString(file);
});

// ðŸ”¹ Reports
document.getElementById("btnImportReports").addEventListener("click", () => {
  new bootstrap.Modal(document.getElementById("modalPeriodo")).show();
});

document.getElementById("confirmarPeriodo").addEventListener("click", async () => {
  const mes = Number(document.getElementById("mesInput").value);
  const ano = Number(document.getElementById("anoInput").value);
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const dataArray = new Uint8Array(e.target.result);
      const workbook = XLSX.read(dataArray, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      let json = XLSX.utils.sheet_to_json(sheet);

      // ðŸ”µ Normaliza chaves apenas para remover espaÃ§os (resolve problema da coluna)
      const normalizedJson = json.map(row => {
        const normalizedRow = {};
        Object.keys(row).forEach(key => normalizedRow[key.trim()] = row[key] !== undefined && row[key] !== "" ? row[key] : null);
        return normalizedRow;
      });

      // ðŸ”µ Formata para Supabase (somente os campos que vocÃª precisa)
      const formatted = normalizedJson.map(row => ({
        member_id: row["Member ID"] || null,
        duracao_video: row["DuraÃ§Ã£o de live de vÃ­deo"] || null,
        duracao_audio: row["DuraÃ§Ã£o de live de Ã¡udio"] || null,
        receita_video: row["Receita de live de vÃ­deo"] || null,
        receita_audio: row["Receita de presentes de live de Ã¡udio"] || null,
        mes: mes,
        ano: ano,
        updated_at: new Date().toISOString()
      }));

      const { error } = await supabase.from("host_reports")
        .upsert(formatted, { onConflict: "member_id,mes,ano" });

      if (error) showStatus(status, "Erro: " + error.message, "btn-error");
      else showStatus(status, "ImportaÃ§Ã£o atualizada com sucesso âœ“", "btn-success");

    } catch (err) {
      showStatus(status, "Erro inesperado: " + err.message, "btn-error");
    }
  };

  reader.readAsArrayBuffer(file);
});

// ðŸ”¹ Logout
document.getElementById("btnLogout").addEventListener("click", logout);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
