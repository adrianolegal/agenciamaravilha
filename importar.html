<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importação - Agência Maravilha</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/styles.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(120deg, #0f172a, #1e293b);
      color: white;
      font-family: Arial, sans-serif;
      padding: 30px;
    }
    .container {
      max-width: 700px;
      margin: auto;
    }
    .card {
      background: #1e293b;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    h2 { margin-bottom: 20px; text-align:center; }
    input[type=file] { margin-bottom: 15px; }
    .status {
      margin-top: 10px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .fade { animation: fade 0.5s ease-in-out; }
    @keyframes fade { from {opacity:0} to {opacity:1} }
    .btn-brand { background:#2563eb; color:white; font-weight:bold; }
    .btn-sm { padding:10px 20px; font-size:1rem; border-radius:6px; }
    .btn-brand:hover { opacity:0.85; }
  </style>
</head>

<body>

<div class="container">
  <h2>Importação de Dados</h2>

  <div class="card">
    <h4>Importar Hosts (Tabela 1)</h4>
    <input type="file" id="fileHosts" accept=".xlsx">
    <button id="btnImportHosts" class="btn btn-brand btn-sm">Importar Hosts</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <div class="card">
    <h4>Importar Relatórios (Tabela 2)</h4>
    <input type="file" id="fileReports" accept=".xlsx">
    <button id="btnImportReports" class="btn btn-brand btn-sm">Importar Relatórios</button>
    <div id="statusReports" class="status"></div>
  </div>

  <div class="d-flex justify-content-center mt-4">
    <button id="btnLogout" class="btn btn-outline-light btn-sm">Logout</button>
  </div>
</div>

<script type="module">
  import { supabase, protectPage, logout } from "./supabase.js";
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mjs";

  // Protege a página
  protectPage();

  function showStatus(el, text, type) {
    el.className = "status fade " + type;
    el.innerText = text;
  }

  // Importar Hosts
  document.getElementById("btnImportHosts").addEventListener("click", async () => {
    const file = document.getElementById("fileHosts").files[0];
    const status = document.getElementById("statusHosts");
    if (!file) return showStatus(status, "Selecione um arquivo", "error");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const workbook = XLSX.read(e.target.result, { type: "binary" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawData = XLSX.utils.sheet_to_json(sheet);

      const data = rawData.map(row => ({
        "member_Id": row["member_Id"],
        "Apelido de streamer": row["Apelido de streamer"],
        "kwaiId": row["kwaiId"],
        "Status de streamer": row["Status de streamer"],
        "Data de entrada": row["Data de entrada"],
        "Última transmissão ao vivo em": row["Última transmissão ao vivo em"],
        "Última publicação em": row["Última publicação em"],
        "Fluxo da transmissão ao vivo este  mês": row["Fluxo da transmissão ao vivo este  mês"],
        "Duração da transmissão ao vivo  este mês": row["Duração da transmissão ao vivo  este mês"],
        "Dias válidos de transmissão ao  vivo este mês": row["Dias válidos de transmissão ao  vivo este mês"],
      }));

      const { error } = await supabase
        .from("hosts")
        .upsert(data, { onConflict: "member_Id" });

      if (error) showStatus(status, "Erro: " + error.message, "error");
      else showStatus(status, "Importado com sucesso ✓", "success");
    };
    reader.readAsBinaryString(file);
  });

  // Importar Relatórios
  document.getElementById("btnImportReports").addEventListener("click", async () => {
    const file = document.getElementById("fileReports").files[0];
    const status = document.getElementById("statusReports");
    if (!file) return showStatus(status, "Selecione um arquivo", "error");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const workbook = XLSX.read(e.target.result, { type: "binary" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet);

      const { error } = await supabase.from("host_reports").insert(data);
      if (error) showStatus(status, "Erro: " + error.message, "error");
      else showStatus(status, "Importado com sucesso ✓", "success");
    };
    reader.readAsBinaryString(file);
  });

  // Logout
  document.getElementById("btnLogout").addEventListener("click", logout);
</script>

</body>
</html>
