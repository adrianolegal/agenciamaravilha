<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importação - Agência Maravilha</title>
  <link rel="icon" href="assets/logo.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/styles.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(120deg, #0f172a, #1e293b);
      color: white;
      font-family: Arial, sans-serif;
      padding: 40px;
    }
    .container {
      max-width: 700px;
      margin: auto;
    }
    .card {
      background:#1e293b;
      padding:20px;
      border-radius:12px;
      margin-bottom:20px;
      box-shadow:0 6px 20px rgba(0,0,0,0.4);
    }
    h2,h3 { margin-bottom:20px; }
    input[type="file"] { margin-bottom:12px; }
    .btn-brand {
      background:#2563eb;
      color:white;
      font-weight:bold;
    }
    .btn-brand:hover { opacity:0.85; }
    .btn-sm { padding:8px 20px; font-size:0.95rem; border-radius:6px; }
    .status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
    .fade { animation: fade 0.5s ease-in-out; }
    @keyframes fade { from { opacity:0 } to { opacity:1 } }
  </style>
</head>

<body>

<div class="container">
  <h2>Importação de Dados V01.0</h2>

  <div class="card">
    <h3>Importar Hosts (Tabela Kwai)</h3>
    <input type="file" id="fileHosts" accept=".xlsx" class="form-control">
    <button id="btnImportHosts" class="btn btn-brand btn-sm">Importar</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <div class="card">
    <h3>Importar Relatórios (Tabela Kwai)</h3>
    <input type="file" id="fileReports" accept=".xlsx" class="form-control">
    <button id="btnImportReports" class="btn btn-brand btn-sm">Importar</button>
    <div id="statusReports" class="status"></div>
  </div>

  <button id="btnLogout" class="btn btn-outline-light btn-sm mt-2">Logout</button>
</div>

<script type="module">
  import { supabase, logout, protectPage } from "./supabase.js";

  // Protege a página
  protectPage();

  function showStatus(element, text, type) {
    element.className = "status fade " + type;
    element.innerText = text;
  }

  // Função para importar Hosts
  document.getElementById("btnImportHosts").addEventListener("click", async () => {
    const file = document.getElementById("fileHosts").files[0];
    const status = document.getElementById("statusHosts");
    if (!file) return showStatus(status, "Selecione um arquivo", "error");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const workbook = XLSX.read(e.target.result, { type: 'binary' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet);

      const { error } = await supabase
        .from('hosts')
        .upsert(data, { onConflict: 'member_Id' });

      if (error) showStatus(status, "Erro ao importar: " + error.message, "error");
      else showStatus(status, "Importado com sucesso ✓", "success");
    };
    reader.readAsBinaryString(file);
  });

  // Função para importar Relatórios
  document.getElementById("btnImportReports").addEventListener("click", async () => {
    const file = document.getElementById("fileReports").files[0];
    const status = document.getElementById("statusReports");
    if (!file) return showStatus(status, "Selecione um arquivo", "error");

    const reader = new FileReader();
    reader.onload = async (e) => {
      const workbook = XLSX.read(e.target.result, { type: 'binary' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(sheet);

      const { error } = await supabase
        .from('host_reports')
        .insert(data);

      if (error) showStatus(status, "Erro ao importar: " + error.message, "error");
      else showStatus(status, "Importado com sucesso ✓", "success");
    };
    reader.readAsBinaryString(file);
  });

  // Logout
  document.getElementById("btnLogout").addEventListener("click", logout);
</script>

<!-- XLSX library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
