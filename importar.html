<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importar - AgÃªncia Maravilha</title>
<link rel="icon" href="assets/logo.jpg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color: white;
  font-family: Arial, sans-serif;
  padding: 40px;
}
.container { max-width: 800px; margin:auto; }
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
button {
  font-weight:bold;
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:10px 20px;
  margin-top:10px;
}
.btn-brand { background:#2563eb; color:white; }
.btn-success { background:#16a34a; color:white; }
.btn-error { background:#dc2626; color:white; }
.status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
.fade { animation: fade 0.5s ease-in-out; }
@keyframes fade { from { opacity:0 } to { opacity:1 } }
</style>
</head>

<body>
<div class="container">
  <h2>ImportaÃ§Ã£o de Dados V.02.0</h2>

  <div class="card">
    <h3>Importar Hosts (Tabela 1)</h3>
    <input type="file" id="fileHosts" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportHosts">Importar Hosts</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <div class="card">
    <h3>Importar RelatÃ³rios Lives (Tabela 2)</h3>
    <input type="file" id="fileReports" accept=".xlsx">
    <button class="btn btn-brand" id="btnImportReports">Importar Reports</button>
    <div id="statusReports" class="status"></div>
  </div>

  <button class="btn btn-error" id="btnLogout">Logout</button>
</div>

<!-- Biblioteca XLSX -->
<script type="module">
import { supabase, protectPage, logout } from "./supabase.js";
import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.19.0/package/xlsx.mjs";

await protectPage(); // protege a pÃ¡gina

function showStatus(element, text, type="") {
  element.className = "status fade " + type;
  element.innerText = text;
}

// FunÃ§Ã£o para tratar dados problemÃ¡ticos do Excel
function normalizeData(sheetData) {
  return sheetData.map(row => {
    let newRow = {...row};
    if ('member_Id' in newRow) {
      // forÃ§a member_Id como string sem notaÃ§Ã£o cientÃ­fica
      newRow.member_Id = String(Math.floor(Number(newRow.member_Id)));
    }
    // se houver datas em Excel, converte para ISO (opcional)
    if ('Data de entrada' in newRow) newRow['Data de entrada'] = newRow['Data de entrada'] ? new Date(newRow['Data de entrada']).toISOString() : null;
    if ('Ãšltima transmissÃ£o ao vivo em' in newRow) newRow['Ãšltima transmissÃ£o ao vivo em'] = newRow['Ãšltima transmissÃ£o ao vivo em'] ? new Date(newRow['Ãšltima transmissÃ£o ao vivo em']).toISOString() : null;
    if ('Ãšltima publicaÃ§Ã£o em' in newRow) newRow['Ãšltima publicaÃ§Ã£o em'] = newRow['Ãšltima publicaÃ§Ã£o em'] ? new Date(newRow['Ãšltima publicaÃ§Ã£o em']).toISOString() : null;
    return newRow;
  });
}
  function normalizeData(data) {
  return data.map(row => {
    const normalized = { ...row };

    // 1ï¸âƒ£ member_Id sempre nÃºmero (corrige notaÃ§Ã£o cientÃ­fica)
    if (normalized.member_Id) {
      normalized.member_Id = Number(normalized.member_Id);
    }

    // 2ï¸âƒ£ Datas â€” tenta converter string para ISO, se falhar mantÃ©m null
    const dateFields = [
      "Data de entrada",
      "Ãšltima transmissÃ£o ao vivo em",
      "Ãšltima publicaÃ§Ã£o em"
    ];

    dateFields.forEach(field => {
      if (normalized[field]) {
        const d = new Date(normalized[field]);
        normalized[field] = isNaN(d.getTime()) ? null : d.toISOString();
      } else {
        normalized[field] = null;
      }
    });

    return normalized;
  });
}

// ðŸ“¤ IMPORT HOSTS
document.getElementById("btnImportHosts").addEventListener("click", async () => {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawData = XLSX.utils.sheet_to_json(sheet);
    const data = normalizeData(rawData);

    const { error } = await supabase.from('hosts').upsert(data, { onConflict: 'member_Id' });
    if (error) showStatus(status, "Erro ao importar: " + error.message, "btn-error");
    else showStatus(status, "Importado com sucesso âœ“", "btn-success");
  
// normaliza antes de enviar
data = normalizeData(data);

const { error } = await supabase.from('hosts').upsert(data, { onConflict: 'member_Id' });
    
  };
  reader.readAsBinaryString(file);
});

// ðŸ“¤ IMPORT REPORTS
document.getElementById("btnImportReports").addEventListener("click", async () => {
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");
  if (!file) return showStatus(status, "Selecione um arquivo", "btn-error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rawData = XLSX.utils.sheet_to_json(sheet);
    const data = normalizeData(rawData);

    const { error } = await supabase.from('host_reports').insert(data);
    if (error) showStatus(status, "Erro ao importar: " + error.message, "btn-error");
    else showStatus(status, "Importado com sucesso âœ“", "btn-success");
  };
  reader.readAsBinaryString(file);
});

// ðŸšª LOGOUT
document.getElementById("btnLogout").addEventListener("click", logout);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
