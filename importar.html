<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importação - Agência Maravilha</title>
<link rel="icon" type="image/png" href="assets/favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="assets/styles.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color: white;
  font-family: Arial, sans-serif;
  padding: 40px;
}
.container {
  max-width: 700px;
  margin: auto;
}
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
input[type="file"] {
  margin-bottom:12px;
}
.btn-brand { background:#2563eb; color:white; font-weight:bold; }
.btn-sm { padding:8px 20px; font-size:1rem; border-radius:6px; }
.btn-brand:hover { opacity:0.85; }
.status { margin-top:10px; font-weight:bold; transition: all 0.3s ease; }
.fade { animation: fade 0.5s ease-in-out; }
@keyframes fade { from { opacity:0 } to { opacity:1 } }
</style>
</head>

<body>

<div class="container">
  <h2>Importação de Dados</h2>

  <!-- IMPORTAR HOSTS -->
  <div class="card">
    <h4>Importar Hosts (Lives)</h4>
    <input type="file" id="fileHosts" accept=".xlsx">
    <button class="btn btn-brand btn-sm" id="btnImportHosts">Importar Hosts</button>
    <div id="statusHosts" class="status"></div>
  </div>

  <!-- IMPORTAR REPORTS -->
  <div class="card">
    <h4>Importar Relatórios (Reports)</h4>
    <input type="file" id="fileReports" accept=".xlsx">
    <button class="btn btn-brand btn-sm" id="btnImportReports">Importar Reports</button>
    <div id="statusReports" class="status"></div>
  </div>

  <button class="btn btn-brand btn-sm" id="btnLogout">Logout</button>
</div>

<script type="module">
import { supabase, logout, protectPage } from "./supabase.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.mjs";

// Protege a página
protectPage();

// Função de exibir status
function showStatus(el, text, type) {
  el.className = "status fade " + type;
  el.innerText = text;
}

// IMPORTAR HOSTS
document.getElementById("btnImportHosts").addEventListener("click", async () => {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");
  if (!file) return showStatus(status, "Selecione um arquivo", "text-danger");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    // Alinha os nomes do Excel para os nomes do Supabase (hosts)
    const formatted = data.map(row => ({
      member_Id: row["member_Id"],
      apelido: row["Apelido de streamer"],
      kwaiId: row["kwaiId"],
      status_streamer: row["Status de streamer"],
      data_entrada: row["Data de entrada"],
      ultima_live: row["Última transmissão ao vivo em"],
      ultima_publicacao: row["Última publicação em"],
      fluxo_mes: row["Fluxo da transmissão ao vivo este mês"],
      duracao_mes: row["Duração da transmissão ao vivo este mês"],
      dias_validos_mes: row["Dias válidos de transmissão ao vivo este mês"]
    }));

    const { error } = await supabase
      .from('hosts')
      .upsert(formatted, { onConflict: 'member_Id' });

    if (error) showStatus(status, "Erro ao importar: " + error.message, "text-danger");
    else showStatus(status, "Importado com sucesso ✓", "text-success");
  };
  reader.readAsBinaryString(file);
});

// IMPORTAR REPORTS (exemplo com outra tabela)
document.getElementById("btnImportReports").addEventListener("click", async () => {
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");
  if (!file) return showStatus(status, "Selecione um arquivo", "text-danger");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    // Aqui você pode mapear os campos para a tabela reports conforme o Excel de reports
    const formatted = data.map(row => ({
      // exemplo: ajuste de acordo com colunas reais do Excel reports
      coluna1: row["Coluna1"],
      coluna2: row["Coluna2"],
      coluna3: row["Coluna3"]
    }));

    const { error } = await supabase
      .from('reports')
      .insert(formatted);

    if (error) showStatus(status, "Erro ao importar: " + error.message, "text-danger");
    else showStatus(status, "Importado com sucesso ✓", "text-success");
  };
  reader.readAsBinaryString(file);
});

// Logout
document.getElementById("btnLogout").addEventListener("click", logout);
</script>

</body>
</html>
