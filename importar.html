<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin - Importação</title>
<link rel="icon" type="image/png" href="assets/favicon.png">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(120deg, #0f172a, #1e293b);
  color:white;
  padding:40px;
  transition: all 0.3s ease;
}
.container {
  max-width:700px;
  margin:auto;
  text-align:center;
}
.logo {
  width:120px;
  margin-bottom:20px;
}
.card {
  background:#1e293b;
  padding:25px;
  border-radius:12px;
  margin-bottom:25px;
  box-shadow:0 4px 15px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}
.card:hover {
  transform: translateY(-5px);
}
button {
  padding:12px 25px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin-top:10px;
  transition: all 0.2s ease;
}
button:hover {
  opacity:0.85;
}
.success { background:#16a34a }
.error { background:#dc2626 }
.info { background:#2563eb }
.status {
  margin-top:12px;
  font-weight:bold;
  transition: all 0.3s ease;
}
.fade {
  animation: fade 0.5s ease-in-out;
}
@keyframes fade {
  from { opacity:0 }
  to { opacity:1 }
}
</style>
</head>
<body>

<div class="container">

<img src="assets/logo.png" alt="Logo" class="logo">

<h2>Painel Admin</h2>

<div class="card">
<h3>Importar Hosts (Tabela 1)</h3>
<input type="file" id="fileHosts" accept=".xlsx">
<button class="info" id="btnImportHosts">Importar</button>
<div id="statusHosts" class="status"></div>
</div>

<div class="card">
<h3>Importar Relatório Lives (Tabela 2)</h3>
<input type="file" id="fileReports" accept=".xlsx">
<button class="info" id="btnImportReports">Importar</button>
<div id="statusReports" class="status"></div>
</div>

<button class="error" id="logoutBtn">Logout</button>

<script type="module">
import { supabaseClient, checkAuth, logout } from "./supabase.js";

// Verifica sessão
async function init() {
  const session = await checkAuth();
  if (!session) window.location.href = "login.html";
}
init();

// Função para exibir status
function showStatus(element, text, type) {
  element.className = "status fade " + type;
  element.innerText = text;
}

// Import Hosts
async function importHosts() {
  const file = document.getElementById("fileHosts").files[0];
  const status = document.getElementById("statusHosts");

  if (!file) return showStatus(status, "Selecione um arquivo", "error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    const { error } = await supabaseClient
      .from('hosts')
      .upsert(data, { onConflict: 'member_id' });

    if (error) showStatus(status, "Erro ao importar", "error");
    else showStatus(status, "Importado com sucesso ✓", "success");
  }
  reader.readAsBinaryString(file);
}

// Import Reports
async function importReports() {
  const file = document.getElementById("fileReports").files[0];
  const status = document.getElementById("statusReports");

  if (!file) return showStatus(status, "Selecione um arquivo", "error");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    const { error } = await supabaseClient
      .from('host_reports')
      .insert(data);

    if (error) showStatus(status, "Erro ao importar", "error");
    else showStatus(status, "Importado com sucesso ✓", "success");
  }
  reader.readAsBinaryString(file);
}

// Listeners
document.getElementById("btnImportHosts").addEventListener("click", importHosts);
document.getElementById("btnImportReports").addEventListener("click", importReports);
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await logout();
  window.location.href = "login.html";
});
</script>

</body>
</html>
