<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin - Importa√ß√£o</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial;
  background:#0f172a;
  color:white;
  padding:40px;
}
.container {
  max-width:600px;
  margin:auto;
}
.card {
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
button {
  padding:10px 20px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
.success { background:#16a34a }
.error { background:#dc2626 }
.info { background:#2563eb }
.status {
  margin-top:10px;
  font-weight:bold;
  transition: all 0.3s ease;
}
.fade {
  animation: fade 0.5s ease-in-out;
}
@keyframes fade {
  from { opacity:0 }
  to { opacity:1 }
}
</style>
</head>
<body>

<div class="container">

<h2>Painel Admin</h2>

<div class="card">
<h3>Importar Hosts (Tabela 1)</h3>
<input type="file" id="fileHosts" accept=".xlsx">
<button class="info" onclick="importHosts()">Importar</button>
<div id="statusHosts" class="status"></div>
</div>

<div class="card">
<h3>Importar Relat√≥rio Lives (Tabela 2)</h3>
<input type="file" id="fileReports" accept=".xlsx">
<button class="info" onclick="importReports()">Importar</button>
<div id="statusReports" class="status"></div>
</div>

<button class="error" onclick="logout()">Logout</button>

</div>

<script>

const supabase = supabase.createClient(
  "https://qgsfmiywdohybqlnxhdw.supabase.co",
  "sb_publishable_t366PTdSUCD0tqDfnyQ-Uw_2rQ32f_5"
)

// üîí PROTE√á√ÉO
async function checkAuth() {
  const { data } = await supabase.auth.getSession()
  if (!data.session) {
    window.location.href = "login.html"
  }
}
checkAuth()

function showStatus(element, text, type) {
  element.className = "status fade " + type
  element.innerText = text
}

// üì§ IMPORT HOSTS
async function importHosts() {
  const file = document.getElementById("fileHosts").files[0]
  const status = document.getElementById("statusHosts")

  if (!file) return showStatus(status, "Selecione um arquivo", "error")

  const reader = new FileReader()
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' })
    const sheet = workbook.Sheets[workbook.SheetNames[0]]
    const data = XLSX.utils.sheet_to_json(sheet)

    const { error } = await supabase
      .from('hosts')
      .upsert(data, { onConflict: 'member_id' })

    if (error) {
      showStatus(status, "Erro ao importar", "error")
    } else {
      showStatus(status, "Importado com sucesso ‚úì", "success")
    }
  }
  reader.readAsBinaryString(file)
}

// üì§ IMPORT REPORTS
async function importReports() {
  const file = document.getElementById("fileReports").files[0]
  const status = document.getElementById("statusReports")

  if (!file) return showStatus(status, "Selecione um arquivo", "error")

  const reader = new FileReader()
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' })
    const sheet = workbook.Sheets[workbook.SheetNames[0]]
    const data = XLSX.utils.sheet_to_json(sheet)

    const { error } = await supabase
      .from('host_reports')
      .insert(data)

    if (error) {
      showStatus(status, "Erro ao importar", "error")
    } else {
      showStatus(status, "Importado com sucesso ‚úì", "success")
    }
  }
  reader.readAsBinaryString(file)
}

async function logout() {
  await supabase.auth.signOut()
  window.location.href = "login.html"
}

</script>
</body>
</html>
